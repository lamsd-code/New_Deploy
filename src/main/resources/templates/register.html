<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Đăng ký | SkyLand</title>
    <link th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css}" rel="stylesheet">
    <style>
        body {
            background-color: #f3f3f3;
        }
        .card {
            background-color: #35bf76;
            color: white;
            border-radius: 1rem;
        }
        .form-control::placeholder {
            color: rgba(255,255,255,0.7);
        }
        .otp-actions button {
            min-width: 180px;
        }
        .alert-placeholder {
            min-height: 48px;
        }
    </style>
</head>

<body>
<div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="col-12 col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-body p-5">
                <h2 class="fw-bold mb-3 text-uppercase text-center">Đăng ký tài khoản</h2>
                <p class="text-white-50 mb-4 text-center">Nhập thông tin của bạn để tạo tài khoản khách hàng mới.</p>

                <div id="alertContainer" class="alert-placeholder"></div>

                <form id="registerForm" class="text-start">
                    <div class="mb-3">
                        <label class="form-label" for="fullname">Họ và tên</label>
                        <input type="text" class="form-control" id="fullname" name="fullname" placeholder="Nhập họ và tên" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="phone">Số điện thoại</label>
                        <input type="tel" class="form-control" id="phone" name="phone" placeholder="Nhập số điện thoại">
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="email">Email</label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="Nhập email">
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="username">Tên đăng nhập</label>
                        <input type="text" class="form-control" id="username" name="username" placeholder="Nhập tên đăng nhập" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="password">Mật khẩu</label>
                        <input type="password" class="form-control" id="password" name="password" placeholder="Nhập mật khẩu" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="confirmPassword">Xác nhận mật khẩu</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" placeholder="Nhập lại mật khẩu" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="otp">Mã OTP</label>
                        <input type="text" class="form-control" id="otp" name="otp" placeholder="Nhập mã OTP" required>
                    </div>

                    <div class="d-flex flex-column flex-md-row gap-2 otp-actions mb-3">
                        <button id="sendEmailOtp" class="btn btn-light text-success fw-bold" type="button">
                            Gửi OTP qua Email
                        </button>
                        <button id="sendPhoneOtp" class="btn btn-outline-light fw-bold" type="button">
                            Gửi OTP qua Số điện thoại
                        </button>
                    </div>

                    <button type="submit" class="btn btn-light w-100 fw-bold">Đăng ký</button>
                </form>

                <p class="mt-4 text-center">Đã có tài khoản? <a th:href="@{/login}" class="text-white-50 fw-bold">Đăng nhập</a></p>
            </div>
        </div>
    </div>
</div>

<script th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js}"></script>
<script>
    const form = document.getElementById('registerForm');
    const alertContainer = document.getElementById('alertContainer');
    let selectedChannel = null;

    const showAlert = (message, type = 'danger') => {
        alertContainer.innerHTML = `<div class="alert alert-${type}" role="alert">${message}</div>`;
    };

    const clearAlert = () => {
        alertContainer.innerHTML = '';
    };

    const buildRegistrationPayload = () => ({
        fullname: document.getElementById('fullname').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim(),
        username: document.getElementById('username').value.trim(),
        password: document.getElementById('password').value,
        confirmPassword: document.getElementById('confirmPassword').value,
        otp: document.getElementById('otp').value.trim(),
        channel: selectedChannel
    });

    const sendRegistrationOtp = async (channel) => {
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const username = document.getElementById('username').value.trim();

        if (channel === 'EMAIL' && !email) {
            showAlert('Vui lòng nhập email trước khi gửi OTP.');
            return;
        }
        if (channel === 'PHONE' && !phone) {
            showAlert('Vui lòng nhập số điện thoại trước khi gửi OTP.');
            return;
        }

        try {
            const response = await fetch('/auth/register/send-otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel, email, phone, username })
            });
            const data = await response.json();
            if (!response.ok) {
                showAlert(data.message || 'Không thể gửi mã OTP.');
                return;
            }
            selectedChannel = channel;
            showAlert('Đã gửi mã OTP, vui lòng kiểm tra và nhập vào ô bên dưới.', 'success');
        } catch (err) {
            showAlert('Hệ thống bận, vui lòng thử lại sau.');
        }
    };

    document.getElementById('sendEmailOtp').addEventListener('click', () => sendRegistrationOtp('EMAIL'));
    document.getElementById('sendPhoneOtp').addEventListener('click', () => sendRegistrationOtp('PHONE'));

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!selectedChannel) {
            showAlert('Vui lòng gửi mã OTP qua email hoặc số điện thoại trước khi đăng ký.');
            return;
        }

        const payload = buildRegistrationPayload();
        if (!payload.otp) {
            showAlert('Vui lòng nhập mã OTP.');
            return;
        }

        try {
            const response = await fetch('/auth/register/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) {
                showAlert(data.message || 'Đăng ký thất bại, vui lòng kiểm tra lại thông tin.');
                return;
            }
            showAlert('Đăng ký thành công! Bạn có thể đăng nhập ngay bây giờ.', 'success');
            form.reset();
            selectedChannel = null;
        } catch (err) {
            showAlert('Không thể đăng ký lúc này, vui lòng thử lại sau.');
        }
    });
</script>
</body>
</html>
